-- Language servers
local servers = {
  rust_analyzer = {},
  ts_ls = {},
  lua_ls = {
    Lua = {
      workspace = { checkThirdParty = false },
      telemetry = { enable = false },
    },
  },
  pyright = {},
}

require('neodev').setup()

local capabilities = vim.lsp.protocol.make_client_capabilities()
capabilities = require('cmp_nvim_lsp').default_capabilities(capabilities)

require('mason').setup()
local mason_lspconfig = require 'mason-lspconfig'

mason_lspconfig.setup {
  ensure_installed = vim.tbl_keys(servers),
}

-- New approach
require('mason-lspconfig').setup {
    handlers = {
        function(server_name)
            local lspconfig = require('lspconfig')
            local opts = {
                capabilities = capabilities,
                on_attach = on_attach,
            }

            if servers[server_name] then
                opts = vim.tbl_deep_extend('force', opts, servers[server_name])
            end

            lspconfig[server_name].setup(opts)
        end,
    },
}
